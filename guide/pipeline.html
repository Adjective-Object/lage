<!DOCTYPE html>
<html lang="en-US">
  <head>
    <meta charset="utf-8">
    <meta name="viewport" content="width=device-width,initial-scale=1">
    <title>Pipeline | lage</title>
    <meta name="generator" content="VuePress 1.5.3">
    
    <meta name="description" content="Monorepo task runner as beautiful as the Norwegian fjords">
    <link rel="preload" href="/lage/assets/css/0.styles.7fb708bc.css" as="style"><link rel="preload" href="/lage/assets/js/app.e7f45559.js" as="script"><link rel="preload" href="/lage/assets/js/2.963cf41f.js" as="script"><link rel="preload" href="/lage/assets/js/15.d87d8841.js" as="script"><link rel="prefetch" href="/lage/assets/js/10.3d8a4750.js"><link rel="prefetch" href="/lage/assets/js/11.bc7cff29.js"><link rel="prefetch" href="/lage/assets/js/12.ee971cda.js"><link rel="prefetch" href="/lage/assets/js/13.e03238fa.js"><link rel="prefetch" href="/lage/assets/js/14.8c2e86fc.js"><link rel="prefetch" href="/lage/assets/js/16.94edca4d.js"><link rel="prefetch" href="/lage/assets/js/17.4233c933.js"><link rel="prefetch" href="/lage/assets/js/18.004585b2.js"><link rel="prefetch" href="/lage/assets/js/3.a4c1e60e.js"><link rel="prefetch" href="/lage/assets/js/4.c2720513.js"><link rel="prefetch" href="/lage/assets/js/5.24fbeba7.js"><link rel="prefetch" href="/lage/assets/js/6.20dd534c.js"><link rel="prefetch" href="/lage/assets/js/7.00d28b65.js"><link rel="prefetch" href="/lage/assets/js/8.9a7fc188.js"><link rel="prefetch" href="/lage/assets/js/9.8e0d2a00.js">
    <link rel="stylesheet" href="/lage/assets/css/0.styles.7fb708bc.css">
  </head>
  <body>
    <div id="app" data-server-rendered="true"><div class="theme-container"><header class="navbar"><div class="sidebar-button"><svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" role="img" viewBox="0 0 448 512" class="icon"><path fill="currentColor" d="M436 124H12c-6.627 0-12-5.373-12-12V80c0-6.627 5.373-12 12-12h424c6.627 0 12 5.373 12 12v32c0 6.627-5.373 12-12 12zm0 160H12c-6.627 0-12-5.373-12-12v-32c0-6.627 5.373-12 12-12h424c6.627 0 12 5.373 12 12v32c0 6.627-5.373 12-12 12zm0 160H12c-6.627 0-12-5.373-12-12v-32c0-6.627 5.373-12 12-12h424c6.627 0 12 5.373 12 12v32c0 6.627-5.373 12-12 12z"></path></svg></div> <a href="/lage/" class="home-link router-link-active"><!----> <span class="site-name">lage</span></a> <div class="links"><div class="search-box"><input aria-label="Search" autocomplete="off" spellcheck="false" value=""> <!----></div> <nav class="nav-links can-hide"><div class="nav-item"><a href="/lage/" class="nav-link">
  Home
</a></div><div class="nav-item"><a href="/lage/guide/" class="nav-link router-link-active">
  Guide
</a></div><div class="nav-item"><a href="https://github.com/microsoft/lage" target="_blank" rel="noopener noreferrer" class="nav-link external">
  Github
  <svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg></a></div> <!----></nav></div></header> <div class="sidebar-mask"></div> <aside class="sidebar"><nav class="nav-links"><div class="nav-item"><a href="/lage/" class="nav-link">
  Home
</a></div><div class="nav-item"><a href="/lage/guide/" class="nav-link router-link-active">
  Guide
</a></div><div class="nav-item"><a href="https://github.com/microsoft/lage" target="_blank" rel="noopener noreferrer" class="nav-link external">
  Github
  <svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg></a></div> <!----></nav>  <ul class="sidebar-links"><li><a href="/lage/" class="sidebar-link">Home</a></li><li><a href="/lage/guide/" class="sidebar-link">Introducing Lage</a></li><li><a href="/lage/guide/getting-started.html" class="sidebar-link">Getting Started</a></li><li><a href="/lage/guide/levels.html" class="sidebar-link">How does lage work?</a></li><li><a href="/lage/guide/scopes.html" class="sidebar-link">Scoped builds</a></li><li><a href="/lage/guide/cache.html" class="sidebar-link">Caching</a></li><li><a href="/lage/guide/remote-cache.html" class="sidebar-link">Remote Cache</a></li><li><a href="/lage/guide/pipeline.html" class="active sidebar-link">Pipeline</a><ul class="sidebar-sub-headers"><li class="sidebar-sub-header"><a href="/lage/guide/pipeline.html#defining-a-pipeline" class="sidebar-link">Defining a pipeline</a></li></ul></li><li><a href="/lage/guide/profile.html" class="sidebar-link">Profiling lage</a></li><li><a href="/lage/guide/priority.html" class="sidebar-link">Priorities</a></li><li><a href="/lage/guide/config.html" class="sidebar-link">Configuration</a></li><li><a href="/lage/guide/cli.html" class="sidebar-link">CLI usage</a></li><li><a href="/lage/guide/migration.html" class="sidebar-link">Migration Guide</a></li></ul> </aside> <main class="page"> <div class="theme-default-content content__default"><h1 id="pipelining-package-tasks"><a href="#pipelining-package-tasks" class="header-anchor">#</a> Pipelining package tasks</h1> <p>In the traditional monorepo task runners, like <code>lerna</code>, each npm lifecycle script like <code>build</code> or <code>test</code> is run topologically or in parallel individually. Depending on the graph of the packages, CPU cores are left idle wasting developer time.</p> <p>Futhermore, the developer is expected to keep track of an <strong>implicit</strong> graph of the tasks. For example, the developer is expected to understand that perhaps the <code>test</code> task is only available after <code>build</code> has completed.</p> <p><code>lage</code> gives developers a way to specify these relationships <strong>explicitly</strong>. The advantage here are two fold. First, incoming new developers can look at <code>lage.config.js</code> and understand how tasks are related. Second, <code>lage</code> can use this explicit declaration to perform an optimized build based on the abundant availability of multi-core processors.</p> <h2 id="defining-a-pipeline"><a href="#defining-a-pipeline" class="header-anchor">#</a> Defining a pipeline</h2> <p>To define the task dependency graph, use the <code>pipeline</code> key in the <code>lage.config.js</code>. For example, this is the default generated configuration when you run <code>npx lage init</code>:</p> <div class="language-js extra-class"><pre class="language-js"><code>module<span class="token punctuation">.</span>exports <span class="token operator">=</span> <span class="token punctuation">{</span>
  pipeline<span class="token operator">:</span> <span class="token punctuation">{</span>
    build<span class="token operator">:</span> <span class="token punctuation">[</span><span class="token string">&quot;^build&quot;</span><span class="token punctuation">]</span><span class="token punctuation">,</span>
    test<span class="token operator">:</span> <span class="token punctuation">[</span><span class="token string">&quot;build&quot;</span><span class="token punctuation">]</span><span class="token punctuation">,</span>
    lint<span class="token operator">:</span> <span class="token punctuation">[</span><span class="token punctuation">]</span><span class="token punctuation">,</span>
  <span class="token punctuation">}</span><span class="token punctuation">,</span>
<span class="token punctuation">}</span><span class="token punctuation">;</span>
</code></pre></div><h3 id="task-dependency-format"><a href="#task-dependency-format" class="header-anchor">#</a> Task dependency format</h3> <p>What you are declaring here in the <code>pipeline</code> object of the configuration is a dependency graph of tasks. The <code>test</code> task above depends on the <code>build</code> task of the same package. The dependencies of <code>test</code> is an array, so it actually can depend on multiple tasks. This may be more relevant in a more complex monorepo.</p> <h3 id="topological-dependency"><a href="#topological-dependency" class="header-anchor">#</a> Topological dependency</h3> <p>The <code>^</code> symbol explicitly declares that the task has a package-topological dependency on another task. For example, if <code>foo</code> package depends on <code>bar</code>, <code>lage build</code> will guarantee that the <code>build</code> task of <code>bar</code> will happen before <code>foo</code>'s <code>build</code> task.</p> <h3 id="empty-dependency-list"><a href="#empty-dependency-list" class="header-anchor">#</a> Empty dependency list</h3> <p>The <code>lint</code> task above has NO dependencies. This means that it can start whenever it can!</p> <h3 id="tasks-that-are-in-the-pipeline-but-not-in-some-package-json"><a href="#tasks-that-are-in-the-pipeline-but-not-in-some-package-json" class="header-anchor">#</a> Tasks that are in the <code>pipeline</code> but not in SOME <code>package.json</code></h3> <p>Sometimes tasks declared in the <code>pipeline</code> are not present in all packages' <code>package.json</code> files. <code>lage</code> will automatically ignore those. No problem!</p> <h3 id="pipeline-tasks-are-the-only-ones-that-lage-knows-about"><a href="#pipeline-tasks-are-the-only-ones-that-lage-knows-about" class="header-anchor">#</a> Pipeline tasks are the only ones that <code>lage</code> knows about</h3> <p><code>lage</code> will only account for tasks declared in the <code>pipeline</code> configuration. If it's not listed there, <code>lage</code> will not know how to run them.</p> <h3 id="specific-package-tasks"><a href="#specific-package-tasks" class="header-anchor">#</a> Specific package tasks</h3> <p>Sometimes it becomes necessary to manually place a package-task dependency on another package-task. This can occur especially in repos that are just coming off of a lerna or rush repository where the tasks are traditionally run in separate phases. Sometimes assumptions were made those repositories that are not expressable in the simple task pipeline configuration as seen above. For thoes cases, simply place those alongside with the rest of the pipeline configuration like this:</p> <div class="language-js extra-class"><pre class="language-js"><code>module<span class="token punctuation">.</span>exports <span class="token operator">=</span> <span class="token punctuation">{</span>
  pipeline<span class="token operator">:</span> <span class="token punctuation">{</span>
    build<span class="token operator">:</span> <span class="token punctuation">[</span><span class="token string">&quot;^build&quot;</span><span class="token punctuation">]</span><span class="token punctuation">,</span>
    test<span class="token operator">:</span> <span class="token punctuation">[</span><span class="token string">&quot;build&quot;</span><span class="token punctuation">]</span><span class="token punctuation">,</span>
    lint<span class="token operator">:</span> <span class="token punctuation">[</span><span class="token punctuation">]</span><span class="token punctuation">,</span>
    <span class="token string">&quot;foo#build&quot;</span><span class="token operator">:</span> <span class="token punctuation">[</span><span class="token string">&quot;bar#test&quot;</span><span class="token punctuation">]</span><span class="token punctuation">,</span>
  <span class="token punctuation">}</span><span class="token punctuation">,</span>
<span class="token punctuation">}</span><span class="token punctuation">;</span>
</code></pre></div><p>In this example, we illustrate a <code>build</code> script of <code>foo</code> package depends on the <code>test</code> script of <code>bar</code>. The syntax is <code>[package]#[task]</code>.</p> <p>This seems like it goes against the <code>test: [&quot;build&quot;]</code>, but it does not. Since <code>test</code> scripts does not have a topological dependency, it theoretically can get triggered anytime its own package's <code>build</code> script has finished! The general guidance is to get rid of these specific package-task to package-task dependency in the pipeline as quickly as possible so the builds can be optimized better.</p></div> <footer class="page-edit"><!----> <!----></footer> <div class="page-nav"><p class="inner"><span class="prev">
      ←
      <a href="/lage/guide/remote-cache.html" class="prev">
        Remote Cache
      </a></span> <span class="next"><a href="/lage/guide/profile.html">
        Profiling lage
      </a>
      →
    </span></p></div> </main></div><div class="global-ui"></div></div>
    <script src="/lage/assets/js/app.e7f45559.js" defer></script><script src="/lage/assets/js/2.963cf41f.js" defer></script><script src="/lage/assets/js/15.d87d8841.js" defer></script>
  </body>
</html>
