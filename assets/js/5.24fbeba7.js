(window.webpackJsonp=window.webpackJsonp||[]).push([[5],{354:function(e,t,a){e.exports=a.p+"assets/img/remote-cache-readonly.d26652e6.png"},370:function(e,t,a){"use strict";a.r(t);var n=a(25),r=Object(n.a)({},(function(){var e=this,t=e.$createElement,n=e._self._c||t;return n("ContentSlotsDistributor",{attrs:{"slot-key":e.$parent.slotKey}},[n("h1",{attrs:{id:"remote-cache"}},[n("a",{staticClass:"header-anchor",attrs:{href:"#remote-cache"}},[e._v("#")]),e._v(" Remote Cache")]),e._v(" "),n("p",[e._v("As your repo grows in size and complexity, the build takes longer and longer even locally. "),n("code",[e._v("lage")]),e._v(" elegantly provides an incremental build capability given a locally available cache. When we pair the caching capability of "),n("code",[e._v("lage")]),e._v(" with a cloud storage provider, we can speed up local builds with remote cache made available by Continuous Integration, or CI, jobs.")]),e._v(" "),n("p",[e._v('The theory is that when the CI job runs, it\'ll produce a "last known good" cache to be uploaded in a cloud storage, like Azure Blob Storage. The remote cache has been made available both for build-over-build speed ups in future CI jobs, as well as the local first build scenario.')]),e._v(" "),n("p",[n("code",[e._v("lage")]),e._v(' has a "fallback cache" mechansim. '),n("code",[e._v("lage")]),e._v(" will look for cache in layers: first on disk, then on remote server. "),n("code",[e._v("lage")]),e._v(" will fill the local cache with the remote one if there is a remote cache hit. Next, "),n("code",[e._v("lage")]),e._v(" will save the locally built cache into the remote cache if the environment variable "),n("code",[e._v("LAGE_WRITE_REMOTE_CACHE")]),e._v(" is set "),n("em",[e._v("and")]),e._v(" if the cache is not configured to use a local provider.")]),e._v(" "),n("h1",{attrs:{id:"setting-up-remote-cache-azure-blob-storage"}},[n("a",{staticClass:"header-anchor",attrs:{href:"#setting-up-remote-cache-azure-blob-storage"}},[e._v("#")]),e._v(" Setting up remote cache - Azure Blob Storage")]),e._v(" "),n("p",[e._v("Follow these steps to set up a remote cache")]),e._v(" "),n("h2",{attrs:{id:"_1-make-sure-to-upgrade-to-latest-lage-v1-0-0"}},[n("a",{staticClass:"header-anchor",attrs:{href:"#_1-make-sure-to-upgrade-to-latest-lage-v1-0-0"}},[e._v("#")]),e._v(" 1. Make sure to upgrade to latest "),n("code",[e._v("lage")]),e._v(" (v1.0.0+)")]),e._v(" "),n("p",[e._v("See "),n("a",{attrs:{href:"./migration"}},[e._v("migration guide")])]),e._v(" "),n("div",{staticClass:"language- extra-class"},[n("pre",{pre:!0,attrs:{class:"language-text"}},[n("code",[e._v("$ yarn upgrade lage\n")])])]),n("h2",{attrs:{id:"_2-add-dotenv-as-a-dependency-for-convenience-locally"}},[n("a",{staticClass:"header-anchor",attrs:{href:"#_2-add-dotenv-as-a-dependency-for-convenience-locally"}},[e._v("#")]),e._v(" 2. Add "),n("code",[e._v("dotenv")]),e._v(" as a dependency (for convenience, locally)")]),e._v(" "),n("div",{staticClass:"language- extra-class"},[n("pre",{pre:!0,attrs:{class:"language-text"}},[n("code",[e._v("$ yarn add -D dotenv\n")])])]),n("h2",{attrs:{id:"_3-add-env-in-your-gitignore-to-make-sure-not-to-check-those-environment-variables-in"}},[n("a",{staticClass:"header-anchor",attrs:{href:"#_3-add-env-in-your-gitignore-to-make-sure-not-to-check-those-environment-variables-in"}},[e._v("#")]),e._v(" 3. Add "),n("code",[e._v(".env")]),e._v(" in your "),n("code",[e._v(".gitignore")]),e._v(" to make sure not to check those environment variables in")]),e._v(" "),n("div",{staticClass:"language- extra-class"},[n("pre",{pre:!0,attrs:{class:"language-text"}},[n("code",[e._v("$ touch .env\n")])])]),n("div",{staticClass:"language- extra-class"},[n("pre",{pre:!0,attrs:{class:"language-text"}},[n("code",[e._v("# .gitignore\n\n.env\nnode_modules\nlib\ndist\n")])])]),n("h2",{attrs:{id:"_4-generate-auth-tokens-from-azure-storage-account"}},[n("a",{staticClass:"header-anchor",attrs:{href:"#_4-generate-auth-tokens-from-azure-storage-account"}},[e._v("#")]),e._v(" 4. Generate auth tokens from Azure storage account:")]),e._v(" "),n("p",[e._v("Prerequisite is to have a working Storage Account with Blob Storage Container created. Note that container name, it'll be needed for Step 5.")]),e._v(" "),n("ol",[n("li",[e._v("Select the following for a "),n("strong",[e._v("read-only")]),e._v(" connection string:\n"),n("img",{attrs:{src:a(354),alt:"remote-cache-readonly"}})]),e._v(" "),n("li",[e._v("Set the start & expiry time to something appropriate")]),e._v(" "),n("li",[e._v('Click "Generate SAS and connection string" button')]),e._v(" "),n("li",[e._v('Save the "connection string" - this is your '),n("strong",[e._v("read-only")]),e._v(" connection string")]),e._v(" "),n("li",[e._v('Click on "Access Keys" tab on the left')]),e._v(" "),n("li",[e._v('Click "show keys"')]),e._v(" "),n("li",[e._v('Save the "connection string" - this is your '),n("strong",[e._v("read-write")]),e._v(" connection string (alternatively, you can create a read-write SAS connection string)")])]),e._v(" "),n("h2",{attrs:{id:"_5-modify-the-env-file-with-the-remote-cache-connection-information"}},[n("a",{staticClass:"header-anchor",attrs:{href:"#_5-modify-the-env-file-with-the-remote-cache-connection-information"}},[e._v("#")]),e._v(" 5. Modify the "),n("code",[e._v(".env")]),e._v(" file with the remote cache connection information")]),e._v(" "),n("div",{staticClass:"language- extra-class"},[n("pre",{pre:!0,attrs:{class:"language-text"}},[n("code",[e._v('# .env file contents\n\n## This is required as of right now\nBACKFILL_CACHE_PROVIDER="azure-blob"\n\n## READ-ONLY SAS\nBACKFILL_CACHE_PROVIDER_OPTIONS={"connectionString":"the **read-only** connection string","container":"CONTAINER NAME"}\n')])])]),n("h2",{attrs:{id:"_6-create-a-secret-in-the-ci-system-for-a-read-write-token"}},[n("a",{staticClass:"header-anchor",attrs:{href:"#_6-create-a-secret-in-the-ci-system-for-a-read-write-token"}},[e._v("#")]),e._v(' 6. Create a "secret" in the CI system for a Read/Write token')]),e._v(" "),n("p",[e._v("Here's an example snippet of Github Action with the correct environment variable set:")]),e._v(" "),n("div",{staticClass:"language-yaml extra-class"},[n("pre",{pre:!0,attrs:{class:"language-yaml"}},[n("code",[n("span",{pre:!0,attrs:{class:"token punctuation"}},[e._v("-")]),e._v(" "),n("span",{pre:!0,attrs:{class:"token key atrule"}},[e._v("run")]),n("span",{pre:!0,attrs:{class:"token punctuation"}},[e._v(":")]),e._v(" yarn lage build test "),n("span",{pre:!0,attrs:{class:"token punctuation"}},[e._v("-")]),n("span",{pre:!0,attrs:{class:"token punctuation"}},[e._v("-")]),e._v("verbose\n  "),n("span",{pre:!0,attrs:{class:"token key atrule"}},[e._v("env")]),n("span",{pre:!0,attrs:{class:"token punctuation"}},[e._v(":")]),e._v("\n    "),n("span",{pre:!0,attrs:{class:"token key atrule"}},[e._v("BACKFILL_CACHE_PROVIDER")]),n("span",{pre:!0,attrs:{class:"token punctuation"}},[e._v(":")]),e._v(" azure"),n("span",{pre:!0,attrs:{class:"token punctuation"}},[e._v("-")]),e._v("blob\n    "),n("span",{pre:!0,attrs:{class:"token key atrule"}},[e._v("BACKFILL_CACHE_PROVIDER_OPTIONS")]),n("span",{pre:!0,attrs:{class:"token punctuation"}},[e._v(":")]),e._v(" $"),n("span",{pre:!0,attrs:{class:"token punctuation"}},[e._v("{")]),n("span",{pre:!0,attrs:{class:"token punctuation"}},[e._v("{")]),e._v(" secrets.BACKFILL_CACHE_PROVIDER_OPTIONS "),n("span",{pre:!0,attrs:{class:"token punctuation"}},[e._v("}")]),n("span",{pre:!0,attrs:{class:"token punctuation"}},[e._v("}")]),e._v("\n    "),n("span",{pre:!0,attrs:{class:"token key atrule"}},[e._v("LAGE_WRITE_REMOTE_CACHE")]),n("span",{pre:!0,attrs:{class:"token punctuation"}},[e._v(":")]),e._v(" "),n("span",{pre:!0,attrs:{class:"token boolean important"}},[e._v("true")]),e._v("\n")])])]),n("p",[e._v('Create a secret named "BACKFILL_CACHE_PROVIDER_OPTIONS":')]),e._v(" "),n("div",{staticClass:"language- extra-class"},[n("pre",{pre:!0,attrs:{class:"language-text"}},[n("code",[e._v('{"connectionString":"the **read-write** connection string","container":"CONTAINER NAME"}\n')])])]),n("blockquote",[n("p",[e._v("Please note that without that "),n("code",[e._v("LAGE_WRITE_REMOTE_CACHE")]),e._v(" environment variable, "),n("code",[e._v("lage")]),e._v(" no longer uploads build caches to the remote server.")])])])}),[],!1,null,null,null);t.default=r.exports}}]);